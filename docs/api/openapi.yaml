openapi: 3.0.3

info:
  title: Juniper Bible API
  version: 0.2.0
  description: |
    REST API for the Juniper Bible capsule management system. This API provides endpoints for:
    - Managing Bible capsules (upload, retrieve, delete)
    - Converting between Bible formats
    - Querying available plugins and formats
    - Asynchronous job management
    - Real-time WebSocket progress updates

    ## Authentication

    The API supports optional API key authentication via the `X-API-Key` header. When enabled,
    all endpoints except `/` and `/health` require a valid API key.

    ## Rate Limiting

    The API can be configured with rate limiting (requests per minute with burst support).

    ## WebSocket

    Real-time progress updates are available via WebSocket at `/ws`. Messages include
    progress, completion, and error notifications for long-running operations.

  contact:
    name: Juniper Bible API
    url: https://github.com/FocuswithJustin/mimicry

  license:
    name: MIT
    url: https://opensource.org/licenses/MIT

servers:
  - url: http://localhost:8080
    description: Local development server
  - url: https://localhost:8080
    description: Local development server (TLS)

tags:
  - name: info
    description: Server information and health checks
  - name: capsules
    description: Capsule management operations
  - name: conversion
    description: Format conversion operations
  - name: jobs
    description: Asynchronous job management
  - name: metadata
    description: Plugin and format information
  - name: websocket
    description: Real-time progress updates

security:
  - ApiKeyAuth: []
  - {}

paths:
  /:
    get:
      tags:
        - info
      summary: Get API information
      description: Returns basic API information, version, and available endpoints
      operationId: getApiInfo
      security: []
      responses:
        '200':
          description: API information
          content:
            application/json:
              schema:
                allOf:
                  - $ref: '#/components/schemas/APIResponse'
                  - type: object
                    properties:
                      data:
                        type: object
                        properties:
                          name:
                            type: string
                            example: Juniper Bible API
                          version:
                            type: string
                            example: 0.2.0
                          docs:
                            type: string
                            example: /api/docs
                          endpoints:
                            type: array
                            items:
                              type: string
                            example:
                              - GET /health
                              - GET /capsules
                              - POST /capsules
                              - GET /capsules/:id
                              - DELETE /capsules/:id
                              - POST /convert
                              - GET /plugins
                              - GET /formats
                              - WS /ws
                              - POST /jobs
                              - GET /jobs/:id
                              - DELETE /jobs/:id

  /health:
    get:
      tags:
        - info
      summary: Health check
      description: Returns server health status, version, uptime, and resource counts
      operationId: getHealth
      security: []
      responses:
        '200':
          description: Server health information
          content:
            application/json:
              schema:
                allOf:
                  - $ref: '#/components/schemas/APIResponse'
                  - type: object
                    properties:
                      data:
                        $ref: '#/components/schemas/HealthInfo'

  /capsules:
    get:
      tags:
        - capsules
      summary: List all capsules
      description: Retrieves a list of all available Bible capsules
      operationId: listCapsules
      responses:
        '200':
          description: List of capsules
          content:
            application/json:
              schema:
                allOf:
                  - $ref: '#/components/schemas/APIResponse'
                  - type: object
                    properties:
                      data:
                        type: array
                        items:
                          $ref: '#/components/schemas/CapsuleInfo'
        '401':
          $ref: '#/components/responses/UnauthorizedError'

    post:
      tags:
        - capsules
      summary: Upload a new capsule
      description: |
        Upload a new Bible capsule file. Supports tar, tar.gz, and tar.xz formats.
        Maximum file size is 1GB. Files are validated for correct format and malicious content.
      operationId: uploadCapsule
      requestBody:
        required: true
        content:
          multipart/form-data:
            schema:
              type: object
              required:
                - file
              properties:
                file:
                  type: string
                  format: binary
                  description: Bible capsule file (tar, tar.gz, or tar.xz)
      responses:
        '201':
          description: Capsule created successfully
          content:
            application/json:
              schema:
                allOf:
                  - $ref: '#/components/schemas/APIResponse'
                  - type: object
                    properties:
                      data:
                        $ref: '#/components/schemas/CapsuleInfo'
        '400':
          $ref: '#/components/responses/BadRequestError'
        '401':
          $ref: '#/components/responses/UnauthorizedError'
        '413':
          description: File too large
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /capsules/{id}:
    get:
      tags:
        - capsules
      summary: Get capsule details
      description: Retrieve detailed information about a specific capsule including manifest and artifacts
      operationId: getCapsule
      parameters:
        - $ref: '#/components/parameters/CapsuleId'
      responses:
        '200':
          description: Capsule details
          content:
            application/json:
              schema:
                allOf:
                  - $ref: '#/components/schemas/APIResponse'
                  - type: object
                    properties:
                      data:
                        $ref: '#/components/schemas/CapsuleInfo'
        '400':
          $ref: '#/components/responses/BadRequestError'
        '401':
          $ref: '#/components/responses/UnauthorizedError'
        '404':
          $ref: '#/components/responses/NotFoundError'

    delete:
      tags:
        - capsules
      summary: Delete a capsule
      description: Permanently delete a capsule from the server
      operationId: deleteCapsule
      parameters:
        - $ref: '#/components/parameters/CapsuleId'
      responses:
        '200':
          description: Capsule deleted successfully
          content:
            application/json:
              schema:
                allOf:
                  - $ref: '#/components/schemas/APIResponse'
                  - type: object
                    properties:
                      data:
                        type: object
                        properties:
                          message:
                            type: string
                            example: Capsule deleted
        '400':
          $ref: '#/components/responses/BadRequestError'
        '401':
          $ref: '#/components/responses/UnauthorizedError'
        '404':
          $ref: '#/components/responses/NotFoundError'

  /convert:
    post:
      tags:
        - conversion
      summary: Convert Bible format (synchronous)
      description: |
        Perform synchronous Bible format conversion. Currently not implemented via API.
        Use the CLI or create an async job via POST /jobs instead.
      operationId: convertSync
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ConvertRequest'
      responses:
        '200':
          description: Conversion completed
          content:
            application/json:
              schema:
                allOf:
                  - $ref: '#/components/schemas/APIResponse'
                  - type: object
                    properties:
                      data:
                        $ref: '#/components/schemas/ConvertResult'
        '400':
          $ref: '#/components/responses/BadRequestError'
        '401':
          $ref: '#/components/responses/UnauthorizedError'
        '501':
          description: Not implemented
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /jobs:
    post:
      tags:
        - jobs
      summary: Create conversion job
      description: |
        Create an asynchronous conversion job. The job executes in the background
        and can be monitored via GET /jobs/{id} or WebSocket.
      operationId: createJob
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ConvertRequest'
      responses:
        '201':
          description: Job created and started
          content:
            application/json:
              schema:
                allOf:
                  - $ref: '#/components/schemas/APIResponse'
                  - type: object
                    properties:
                      data:
                        $ref: '#/components/schemas/Job'
        '400':
          $ref: '#/components/responses/BadRequestError'
        '401':
          $ref: '#/components/responses/UnauthorizedError'

  /jobs/{id}:
    get:
      tags:
        - jobs
      summary: Get job status
      description: Retrieve the current status and progress of an asynchronous job
      operationId: getJob
      parameters:
        - $ref: '#/components/parameters/JobId'
      responses:
        '200':
          description: Job status
          content:
            application/json:
              schema:
                allOf:
                  - $ref: '#/components/schemas/APIResponse'
                  - type: object
                    properties:
                      data:
                        $ref: '#/components/schemas/Job'
        '400':
          $ref: '#/components/responses/BadRequestError'
        '401':
          $ref: '#/components/responses/UnauthorizedError'
        '404':
          $ref: '#/components/responses/NotFoundError'

    delete:
      tags:
        - jobs
      summary: Cancel job
      description: Cancel a pending or running job. Completed jobs cannot be cancelled.
      operationId: cancelJob
      parameters:
        - $ref: '#/components/parameters/JobId'
      responses:
        '200':
          description: Job cancelled successfully
          content:
            application/json:
              schema:
                allOf:
                  - $ref: '#/components/schemas/APIResponse'
                  - type: object
                    properties:
                      data:
                        type: object
                        properties:
                          message:
                            type: string
                            example: Job cancelled
        '400':
          $ref: '#/components/responses/BadRequestError'
        '401':
          $ref: '#/components/responses/UnauthorizedError'
        '404':
          $ref: '#/components/responses/NotFoundError'

  /plugins:
    get:
      tags:
        - metadata
      summary: List available plugins
      description: Retrieve information about all available format and tool plugins
      operationId: listPlugins
      responses:
        '200':
          description: List of plugins
          content:
            application/json:
              schema:
                allOf:
                  - $ref: '#/components/schemas/APIResponse'
                  - type: object
                    properties:
                      data:
                        type: array
                        items:
                          $ref: '#/components/schemas/PluginInfo'
        '401':
          $ref: '#/components/responses/UnauthorizedError'

  /formats:
    get:
      tags:
        - metadata
      summary: List supported formats
      description: |
        Retrieve information about all supported Bible formats including
        loss classification, capabilities, and file extensions
      operationId: listFormats
      responses:
        '200':
          description: List of supported formats
          content:
            application/json:
              schema:
                allOf:
                  - $ref: '#/components/schemas/APIResponse'
                  - type: object
                    properties:
                      data:
                        type: array
                        items:
                          $ref: '#/components/schemas/FormatInfo'
        '401':
          $ref: '#/components/responses/UnauthorizedError'

  /ws:
    get:
      tags:
        - websocket
      summary: WebSocket connection
      description: |
        Upgrade to WebSocket for real-time progress updates. Messages are sent
        as JSON with progress, completion, and error notifications.

        Message types:
        - progress: Operation progress update (0-100%)
        - complete: Operation completed successfully
        - error: Operation failed

        Operations include: upload, convert, ingest, export
      operationId: websocketConnect
      responses:
        '101':
          description: WebSocket connection established
        '401':
          $ref: '#/components/responses/UnauthorizedError'
        '500':
          description: WebSocket hub not initialized

components:
  securitySchemes:
    ApiKeyAuth:
      type: apiKey
      in: header
      name: X-API-Key
      description: |
        Optional API key authentication. When enabled on the server,
        all endpoints except `/` and `/health` require this header.

        Generate a secure key with:
        ```bash
        openssl rand -base64 32
        ```

  parameters:
    CapsuleId:
      name: id
      in: path
      required: true
      description: Capsule identifier (filename)
      schema:
        type: string
        example: bible.tar.xz

    JobId:
      name: id
      in: path
      required: true
      description: Job UUID
      schema:
        type: string
        format: uuid
        example: 550e8400-e29b-41d4-a716-446655440000

  schemas:
    APIResponse:
      type: object
      required:
        - success
        - meta
      properties:
        success:
          type: boolean
          description: Whether the request was successful
        data:
          type: object
          description: Response data (varies by endpoint)
        error:
          $ref: '#/components/schemas/APIError'
        meta:
          $ref: '#/components/schemas/APIMeta'

    ErrorResponse:
      type: object
      required:
        - success
        - error
        - meta
      properties:
        success:
          type: boolean
          example: false
        error:
          $ref: '#/components/schemas/APIError'
        meta:
          $ref: '#/components/schemas/APIMeta'

    APIError:
      type: object
      required:
        - code
        - message
      properties:
        code:
          type: string
          description: Machine-readable error code
          enum:
            - NOT_FOUND
            - INVALID_REQUEST
            - MISSING_FILE
            - INVALID_FILENAME
            - INVALID_FILE_TYPE
            - INVALID_PATH
            - FILE_TOO_LARGE
            - SAVE_FAILED
            - DELETE_FAILED
            - INVALID_JSON
            - MISSING_PARAMS
            - NOT_IMPLEMENTED
            - METHOD_NOT_ALLOWED
            - UNAUTHORIZED
            - MISSING_ID
            - INVALID_ID
            - CANCEL_FAILED
        message:
          type: string
          description: Human-readable error message

    APIMeta:
      type: object
      required:
        - timestamp
      properties:
        total:
          type: integer
          description: Total count for list operations
          example: 42
        timestamp:
          type: string
          format: date-time
          description: ISO 8601 timestamp
          example: 2026-01-10T12:34:56Z

    HealthInfo:
      type: object
      required:
        - status
        - version
        - uptime
        - capsules
        - plugins
      properties:
        status:
          type: string
          enum:
            - healthy
          example: healthy
        version:
          type: string
          example: 0.2.0
        uptime:
          type: string
          description: Server uptime duration
          example: 2h15m30s
        capsules:
          type: integer
          description: Number of capsules available
          example: 5
        plugins:
          type: integer
          description: Number of plugins loaded
          example: 15

    CapsuleInfo:
      type: object
      required:
        - id
        - name
        - path
        - size
        - format
      properties:
        id:
          type: string
          description: Capsule identifier
          example: bible.tar.xz
        name:
          type: string
          description: Display name
          example: bible.tar.xz
        path:
          type: string
          description: Relative path in capsules directory
          example: bible.tar.xz
        size:
          type: integer
          format: int64
          description: File size in bytes
          example: 1048576
        format:
          type: string
          description: Detected archive format
          enum:
            - tar
            - tar.gz
            - tar.xz
            - unknown
          example: tar.xz
        created_at:
          type: string
          format: date-time
          description: Creation timestamp
          example: 2026-01-10T12:00:00Z
        manifest:
          $ref: '#/components/schemas/CapsuleManifest'
        artifacts:
          type: array
          items:
            $ref: '#/components/schemas/ArtifactInfo'

    CapsuleManifest:
      type: object
      required:
        - version
      properties:
        version:
          type: string
          description: Manifest version
          example: 1.0
        module_type:
          type: string
          description: Type of Bible module
          example: Bible
        title:
          type: string
          description: Bible title
          example: King James Version
        language:
          type: string
          description: Language code
          example: en
        rights:
          type: string
          description: Copyright/licensing information
          example: Public Domain
        source_format:
          type: string
          description: Original format
          example: OSIS
        created_at:
          type: string
          format: date-time
          example: 2026-01-10T12:00:00Z
        metadata:
          type: object
          additionalProperties:
            type: string
          description: Additional metadata key-value pairs

    ArtifactInfo:
      type: object
      required:
        - id
        - name
        - size
      properties:
        id:
          type: string
          description: Artifact identifier (path in archive)
          example: data/genesis.xml
        name:
          type: string
          description: Artifact filename
          example: genesis.xml
        size:
          type: integer
          format: int64
          description: Artifact size in bytes
          example: 204800
        hash:
          type: string
          description: SHA-256 hash (optional)
          example: e3b0c44298fc1c149afbf4c8996fb92427ae41e4649b934ca495991b7852b855

    ConvertRequest:
      type: object
      required:
        - source
        - target_format
      properties:
        source:
          type: string
          description: Source file or capsule path
          example: bible.tar.xz
        target_format:
          type: string
          description: Target format ID
          enum:
            - osis
            - usfm
            - usx
            - zefania
            - theword
            - json
            - sword
            - html
            - epub
            - markdown
            - sqlite
            - esword
            - txt
          example: json
        options:
          type: object
          additionalProperties: true
          description: Format-specific conversion options
          example:
            include_notes: true
            versification: KJV

    ConvertResult:
      type: object
      required:
        - output_path
        - loss_class
        - duration
      properties:
        output_path:
          type: string
          description: Path to converted output
          example: /output/bible.json
        loss_class:
          type: string
          description: Information loss classification
          enum:
            - L0
            - L1
            - L2
            - L3
          example: L0
        duration:
          type: string
          description: Conversion duration
          example: 1.5s

    Job:
      type: object
      required:
        - id
        - status
        - progress
        - created_at
        - updated_at
        - request
      properties:
        id:
          type: string
          format: uuid
          description: Unique job identifier
          example: 550e8400-e29b-41d4-a716-446655440000
        status:
          type: string
          enum:
            - pending
            - running
            - completed
            - failed
            - cancelled
          description: Current job status
          example: running
        progress:
          type: integer
          minimum: 0
          maximum: 100
          description: Completion percentage
          example: 45
        result:
          $ref: '#/components/schemas/ConvertResult'
        error:
          type: string
          description: Error message if status is failed
        created_at:
          type: string
          format: date-time
          description: Job creation timestamp
          example: 2026-01-10T12:00:00Z
        updated_at:
          type: string
          format: date-time
          description: Last update timestamp
          example: 2026-01-10T12:01:30Z
        completed_at:
          type: string
          format: date-time
          description: Completion timestamp (if completed/failed/cancelled)
          example: 2026-01-10T12:02:00Z
        request:
          $ref: '#/components/schemas/ConvertRequest'

    PluginInfo:
      type: object
      required:
        - name
        - type
        - description
      properties:
        name:
          type: string
          description: Plugin name
          example: osis
        type:
          type: string
          enum:
            - format
            - tool
          description: Plugin type
          example: format
        description:
          type: string
          description: Plugin description
          example: Format plugin for osis
        formats:
          type: array
          items:
            type: string
          description: Supported format IDs (for format plugins)
          example:
            - osis

    FormatInfo:
      type: object
      required:
        - id
        - name
        - extensions
        - loss_class
        - description
        - can_extract
        - can_emit
      properties:
        id:
          type: string
          description: Format identifier
          example: osis
        name:
          type: string
          description: Human-readable format name
          example: OSIS XML
        extensions:
          type: array
          items:
            type: string
          description: File extensions
          example:
            - .osis
            - .xml
        loss_class:
          type: string
          enum:
            - L0
            - L1
            - L2
            - L3
          description: |
            Information loss classification:
            - L0: Lossless (perfect round-trip)
            - L1: Minor loss (formatting/styling)
            - L2: Moderate loss (some structural elements)
            - L3: High loss (text only)
          example: L0
        description:
          type: string
          description: Format description
          example: Open Scripture Information Standard
        can_extract:
          type: boolean
          description: Whether format can be read/extracted
          example: true
        can_emit:
          type: boolean
          description: Whether format can be written/emitted
          example: true

    ProgressMessage:
      type: object
      required:
        - type
        - operation
        - timestamp
      properties:
        type:
          type: string
          enum:
            - progress
            - complete
            - error
          description: Message type
          example: progress
        operation:
          type: string
          description: Operation name
          example: convert
        stage:
          type: string
          description: Current operation stage
          example: parsing
        progress:
          type: integer
          minimum: 0
          maximum: 100
          description: Completion percentage
          example: 45
        message:
          type: string
          description: Human-readable status message
          example: Converting Genesis...
        timestamp:
          type: string
          format: date-time
          description: ISO 8601 timestamp
          example: 2026-01-10T12:34:56Z
        data:
          type: object
          additionalProperties: true
          description: Additional operation-specific data

  responses:
    BadRequestError:
      description: Bad request - invalid input
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'
          example:
            success: false
            error:
              code: INVALID_REQUEST
              message: Invalid request parameters
            meta:
              timestamp: 2026-01-10T12:34:56Z

    UnauthorizedError:
      description: Unauthorized - missing or invalid API key
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'
          example:
            success: false
            error:
              code: UNAUTHORIZED
              message: Missing X-API-Key header
            meta:
              timestamp: 2026-01-10T12:34:56Z

    NotFoundError:
      description: Resource not found
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'
          example:
            success: false
            error:
              code: NOT_FOUND
              message: Resource not found
            meta:
              timestamp: 2026-01-10T12:34:56Z
