{{template "header" .}}

{{if .RefreshResult}}
<article>
  {{if .RefreshResult.Success}}
  <div class="alert alert-success">
    <strong>Success!</strong> {{.RefreshResult.Message}}
  </div>
  {{else}}
  <div class="alert alert-error">
    <strong>Error:</strong> {{.RefreshResult.Message}}
  </div>
  {{end}}
</article>
{{end}}

{{if .InstallResult}}
<article>
  {{if .InstallResult.Success}}
  <div class="alert alert-success">
    <strong>Success!</strong> {{.InstallResult.Message}}
  </div>
  {{else}}
  <div class="alert alert-error">
    <strong>Error:</strong> {{.InstallResult.Message}}
  </div>
  {{end}}
</article>
{{end}}

<article>
  <header>
    <h2>SWORD Repository Manager</h2>
    <p class="meta">Download and manage SWORD modules from online repositories</p>
  </header>

  <!-- Source Selection -->
  <form method="get" style="margin-bottom: 1rem;">
    <div style="display: flex; gap: 1rem; align-items: center; flex-wrap: wrap;">
      <div>
        <label for="source" style="margin-right: 0.5rem;"><strong>Repository:</strong></label>
        <select id="source" name="source" onchange="this.form.submit()" style="display: inline-block; width: auto;">
          {{range .Sources}}
          <option value="{{.Name}}" {{if eq .Name $.SelectedSource}}selected{{end}}>{{.Name}}</option>
          {{end}}
        </select>
      </div>
      <div class="meta">
        {{range .Sources}}
        {{if eq .Name $.SelectedSource}}{{.URL}}{{end}}
        {{end}}
      </div>
    </div>
  </form>

  <!-- Refresh Button -->
  <form method="post" style="margin-bottom: 1.5rem;">
    <input type="hidden" name="csrf_token" value="{{.CSRFToken}}">
    <input type="hidden" name="source" value="{{.SelectedSource}}">
    <input type="hidden" name="action" value="refresh">
    <button type="submit" class="secondary outline">Refresh Module List</button>
  </form>
</article>

<!-- Available Modules -->
<article>
  <header>
    <h3>Available Modules from {{.SelectedSource}}</h3>
    <p class="meta">{{len .Modules}} modules available</p>
  </header>

  {{if .Modules}}
  <!-- Filter Controls -->
  <div style="margin-bottom: 1rem; display: flex; gap: 1rem; flex-wrap: wrap; align-items: center;">
    <div>
      <label for="filter-type" style="margin-right: 0.5rem;"><strong>Type:</strong></label>
      <select id="filter-type" onchange="applyFilters()" style="display: inline-block; width: auto;">
        <option value="">All Types</option>
        {{range .Types}}
        <option value="{{.}}">{{.}}</option>
        {{end}}
      </select>
    </div>
    <div>
      <label for="filter-language" style="margin-right: 0.5rem;"><strong>Language:</strong></label>
      <select id="filter-language" onchange="applyFilters()" style="display: inline-block; width: auto;">
        <option value="">All Languages</option>
        {{range .Languages}}
        <option value="{{.}}">{{.}}</option>
        {{end}}
      </select>
    </div>
    <div>
      <label for="filter-search" style="margin-right: 0.5rem;"><strong>Search:</strong></label>
      <input type="text" id="filter-search" oninput="applyFilters()" placeholder="Filter by name..." style="display: inline-block; width: 200px;">
    </div>
    <div>
      <button type="button" onclick="clearFilters()" class="secondary outline" style="padding: 0.25rem 0.75rem;">Clear Filters</button>
    </div>
    <div style="margin-left: auto;">
      <span id="filter-count" class="meta"></span>
    </div>
  </div>

  <!-- Quick Filter Tags -->
  {{if .Types}}
  <div style="margin-bottom: 1rem;">
    <span class="meta" style="margin-right: 0.5rem;">Quick filters:</span>
    {{range .Types}}
    <span class="tag filter-tag" data-filter-type="type" data-filter-value="{{.}}" onclick="toggleTag(this)" style="cursor: pointer; margin: 0.125rem; {{if eq . "Bible"}}background: #28a745; color: white;{{else if eq . "Commentary"}}background: #17a2b8; color: white;{{else if eq . "Dictionary"}}background: #6c757d; color: white;{{else if eq . "GenBook"}}background: #ffc107; color: black;{{else}}background: #e9ecef;{{end}}">{{.}}</span>
    {{end}}
  </div>
  {{end}}

  <div class="table-responsive">
    <table id="modules-table">
      <thead>
        <tr>
          <th style="white-space: nowrap;">Name</th>
          <th>Description</th>
          <th style="white-space: nowrap;">Type</th>
          <th style="white-space: nowrap;">Language</th>
          <th style="white-space: nowrap;">Version</th>
          <th style="white-space: nowrap;">Actions</th>
        </tr>
      </thead>
      <tbody>
        {{range .Modules}}
        <tr data-type="{{.Type}}" data-language="{{.Language}}" data-name="{{.Name}}">
          <td><strong>{{.Name}}</strong></td>
          <td>{{if .Description}}{{truncate .Description 80}}{{else}}<span class="meta">-</span>{{end}}</td>
          <td>
            {{if eq .Type "Bible"}}<span class="tag" style="background: #28a745; color: white; cursor: pointer;" onclick="setFilter('type', '{{.Type}}')">Bible</span>
            {{else if eq .Type "Commentary"}}<span class="tag" style="background: #17a2b8; color: white; cursor: pointer;" onclick="setFilter('type', '{{.Type}}')">Commentary</span>
            {{else if eq .Type "Dictionary"}}<span class="tag" style="background: #6c757d; color: white; cursor: pointer;" onclick="setFilter('type', '{{.Type}}')">Dictionary</span>
            {{else if eq .Type "GenBook"}}<span class="tag" style="background: #ffc107; color: black; cursor: pointer;" onclick="setFilter('type', '{{.Type}}')">GenBook</span>
            {{else}}<span class="tag" style="cursor: pointer;" onclick="setFilter('type', '{{.Type}}')">{{.Type}}</span>{{end}}
          </td>
          <td>{{if .Language}}<span class="tag" style="cursor: pointer; background: #e9ecef;" onclick="setFilter('language', '{{.Language}}')">{{.Language}}</span>{{else}}<span class="meta">-</span>{{end}}</td>
          <td>{{if .Version}}{{.Version}}{{else}}<span class="meta">-</span>{{end}}</td>
          <td>
            <form method="post" style="display: inline;">
              <input type="hidden" name="csrf_token" value="{{$.CSRFToken}}">
              <input type="hidden" name="source" value="{{$.SelectedSource}}">
              <input type="hidden" name="action" value="install">
              <input type="hidden" name="module" value="{{.Name}}">
              <button type="submit" class="secondary outline" style="padding: 0.25rem 0.5rem; font-size: 0.875rem;">Install</button>
            </form>
          </td>
        </tr>
        {{end}}
      </tbody>
    </table>
  </div>
  {{else}}
  <div class="empty-state">
    <p>No modules available from this source.</p>
    <p class="meta">Try clicking "Refresh Module List" to download the latest index.</p>
  </div>
  {{end}}
</article>

<!-- Installed Modules -->
<article>
  <header>
    <h3>Installed Modules</h3>
    <p class="meta">{{len .Installed}} modules in {{.SwordDir}}</p>
  </header>

  {{if .Installed}}
  <div class="table-responsive">
    <table>
      <thead>
        <tr>
          <th style="white-space: nowrap;">Name</th>
          <th>Description</th>
          <th style="white-space: nowrap;">Type</th>
          <th style="white-space: nowrap;">Language</th>
          <th style="white-space: nowrap;">Version</th>
          <th style="white-space: nowrap;">Actions</th>
        </tr>
      </thead>
      <tbody>
        {{range .Installed}}
        <tr>
          <td><strong>{{.Name}}</strong></td>
          <td>{{if .Description}}{{truncate .Description 80}}{{else}}<span class="meta">-</span>{{end}}</td>
          <td>
            {{if eq .Type "Bible"}}<span class="tag" style="background: #28a745; color: white;">Bible</span>
            {{else if eq .Type "Commentary"}}<span class="tag" style="background: #17a2b8; color: white;">Commentary</span>
            {{else if eq .Type "Dictionary"}}<span class="tag" style="background: #6c757d; color: white;">Dictionary</span>
            {{else if eq .Type "GenBook"}}<span class="tag" style="background: #ffc107; color: black;">GenBook</span>
            {{else}}<span class="tag">{{.Type}}</span>{{end}}
          </td>
          <td>{{if .Language}}{{.Language}}{{else}}<span class="meta">-</span>{{end}}</td>
          <td>{{if .Version}}{{.Version}}{{else}}<span class="meta">-</span>{{end}}</td>
          <td>
            <form method="post" style="display: inline;" onsubmit="return confirm('Delete {{.Name}}? This cannot be undone.');">
              <input type="hidden" name="csrf_token" value="{{$.CSRFToken}}">
              <input type="hidden" name="action" value="delete">
              <input type="hidden" name="module" value="{{.Name}}">
              <button type="submit" class="btn-delete">Delete</button>
            </form>
          </td>
        </tr>
        {{end}}
      </tbody>
    </table>
  </div>
  {{else}}
  <div class="empty-state">
    <p>No modules installed yet.</p>
    <p class="meta">Use the repository browser above to install modules.</p>
  </div>
  {{end}}
</article>

<div class="btn-group">
  <a href="/juniper" role="button" class="secondary outline">SWORD Modules</a>
  <a href="/" role="button" class="secondary outline">Back to Home</a>
</div>

<script>
  function applyFilters() {
    const typeFilter = document.getElementById('filter-type').value;
    const langFilter = document.getElementById('filter-language').value;
    const searchFilter = document.getElementById('filter-search').value.toLowerCase();
    const rows = document.querySelectorAll('#modules-table tbody tr');
    let visibleCount = 0;

    rows.forEach(row => {
      const rowType = row.dataset.type || '';
      const rowLang = row.dataset.language || '';
      const rowName = row.dataset.name || '';
      const typeMatch = !typeFilter || rowType === typeFilter;
      const langMatch = !langFilter || rowLang === langFilter;
      const searchMatch = !searchFilter || rowName.toLowerCase().includes(searchFilter);

      if (typeMatch && langMatch && searchMatch) {
        row.style.display = '';
        visibleCount++;
      } else {
        row.style.display = 'none';
      }
    });

    document.getElementById('filter-count').textContent =
      `Showing ${visibleCount} of ${rows.length} modules`;

    // Update tag active states
    updateTagStates();
  }

  function updateTagStates() {
    const typeFilter = document.getElementById('filter-type').value;
    const langFilter = document.getElementById('filter-language').value;

    document.querySelectorAll('.filter-tag').forEach(tag => {
      const filterType = tag.dataset.filterType;
      const filterValue = tag.dataset.filterValue;
      let isActive = false;

      if (filterType === 'type' && typeFilter === filterValue) {
        isActive = true;
      } else if (filterType === 'language' && langFilter === filterValue) {
        isActive = true;
      }

      if (isActive) {
        tag.style.fontWeight = 'bold';
        tag.style.boxShadow = '0 0 0 2px #007bff';
      } else {
        tag.style.fontWeight = 'normal';
        tag.style.boxShadow = 'none';
      }
    });
  }

  function toggleTag(tag) {
    const filterType = tag.dataset.filterType;
    const filterValue = tag.dataset.filterValue;
    const selectId = 'filter-' + filterType;
    const select = document.getElementById(selectId);

    if (select) {
      if (select.value === filterValue) {
        select.value = ''; // Clear if already selected
      } else {
        select.value = filterValue;
      }
      applyFilters();
    }
  }

  function setFilter(filterType, filterValue) {
    const selectId = 'filter-' + filterType;
    const select = document.getElementById(selectId);
    if (select) {
      select.value = filterValue;
      applyFilters();
    }
  }

  function clearFilters() {
    document.getElementById('filter-type').value = '';
    document.getElementById('filter-language').value = '';
    document.getElementById('filter-search').value = '';
    applyFilters();
  }

  // Initialize filter count on page load
  document.addEventListener('DOMContentLoaded', applyFilters);
</script>

{{template "footer" .}}
