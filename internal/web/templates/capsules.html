{{template "header" .}}

<div class="tab-nav">
  <a href="/capsules?tab=list" class="{{if eq .Tab "list"}}active{{end}}" id="tab-list-link">Capsules</a>
  <a href="/capsules?tab=generate" class="{{if eq .Tab "generate"}}active{{end}}" id="tab-generate-link">Generate IR</a>
  <a href="/capsules?tab=export" class="{{if eq .Tab "export"}}active{{end}}" id="tab-export-link">Export</a>
</div>

<!-- Capsules Tab -->
<div class="tab-content {{if eq .Tab "list"}}active{{end}}" id="tab-list">
  <article>
    <header>
      <h2>Capsules</h2>
      <p class="meta">{{.CapsulesDir}}</p>
    </header>
    {{if .Capsules}}
    <div class="table-responsive">
      <table>
        <caption style="caption-side: top; text-align: left; font-weight: bold; padding-bottom: 0.5rem;">Available Capsules</caption>
        <thead>
          <tr>
            <th>Name</th>
            <th>Format</th>
            <th>Size</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          {{range .Capsules}}
          <tr>
            <td><a href="/capsule/{{.Path}}">{{.Name}}</a></td>
            <td><span class="tag">{{.Format}}</span></td>
            <td class="meta">{{.SizeHuman}}</td>
            <td>
              <div class="btn-group">
                <a href="/capsule/{{.Path}}" role="button" class="secondary outline">View</a>
                <a href="/ir/{{.Path}}" role="button" class="secondary outline">IR</a>
                <form method="post" action="/capsules/delete" style="display: inline;" onsubmit="return confirmDeleteCapsule(this);">
                  <input type="hidden" name="csrf_token" value="{{$.CSRFToken}}">
                  <input type="hidden" name="path" value="{{.Path}}">
                  <input type="hidden" class="capsule-name" value="{{.Name}}">
                  <button type="submit" class="btn-delete">Delete</button>
                </form>
              </div>
            </td>
          </tr>
          {{end}}
        </tbody>
      </table>
    </div>
    <p class="meta">Total: {{len .Capsules}} capsule(s)</p>
    {{else}}
    {{template "emptyState" "No capsules found. Add .tar.xz capsules to the capsules directory."}}
    {{end}}
  </article>
</div>

<!-- Generate IR Tab -->
<div class="tab-content {{if eq .Tab "generate"}}active{{end}}" id="tab-generate">
  <article>
    <header>
      <h2>Generate Intermediate Representation</h2>
      <p class="meta">Convert capsule content to IR format for analysis and conversion</p>
    </header>

    {{if .CapsulesNoIR}}
    <form method="post" action="/convert" id="generate-form">
      <input type="hidden" name="csrf_token" value="{{.CSRFToken}}">
      <input type="hidden" name="action" value="generate-ir">

      <div style="margin-bottom: 1rem; display: flex; gap: 1rem; flex-wrap: wrap; align-items: center;">
        <div style="margin-left: auto; display: flex; gap: 0.5rem; align-items: center;">
          <span id="generate-selected-count" class="meta">0 selected</span>
          <button type="button" onclick="selectAllGenerate()" class="secondary outline" style="padding: 0.25rem 0.5rem;">All</button>
          <button type="button" onclick="selectNoneGenerate()" class="secondary outline" style="padding: 0.25rem 0.5rem;">None</button>
          <button type="submit" style="padding: 0.25rem 0.75rem;">Generate IR</button>
        </div>
      </div>

      <div class="table-responsive">
        <table id="generate-table">
          <caption style="caption-side: top; text-align: left; font-weight: bold; padding-bottom: 0.5rem;">Capsules Requiring IR Generation</caption>
          <thead>
            <tr>
              <th style="width: 40px;"><input type="checkbox" id="select-all-generate" aria-label="Select all capsules" onchange="toggleSelectAllGenerate(this)"></th>
              <th>Name</th>
              <th>Format</th>
              <th>Size</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            {{range .CapsulesNoIR}}
            <tr>
              <td><input type="checkbox" name="source" value="{{.Path}}" onchange="updateGenerateCount()"></td>
              <td><a href="/capsule/{{.Path}}">{{.Name}}</a></td>
              <td><span class="tag">{{.Format}}</span></td>
              <td class="meta">{{.SizeHuman}}</td>
              <td>
                <a href="/ir/{{.Path}}" role="button" class="secondary outline" style="padding: 0.25rem 0.5rem; font-size: 0.875rem;">Generate</a>
              </td>
            </tr>
            {{end}}
          </tbody>
        </table>
      </div>
      <p class="meta">{{len .CapsulesNoIR}} capsule(s) without IR</p>
    </form>
    {{else}}
    {{if .Capsules}}
    {{template "emptyState" "All capsules already have IR generated. Use the Export tab to convert to other formats."}}
    {{else}}
    {{template "emptyState" "No capsules found. Add .tar.xz capsules to the capsules directory."}}
    {{end}}
    {{end}}

    <div style="margin-top: 1.5rem; padding: 1rem; background: var(--pico-card-background-color); border-radius: var(--pico-border-radius);">
      <h4>About IR Generation</h4>
      <p class="meta">The Intermediate Representation (IR) is a normalized format that:</p>
      <ul class="meta">
        <li>Extracts text content from capsule source files</li>
        <li>Preserves structural markup (chapters, verses, paragraphs)</li>
        <li>Uses stand-off annotations for overlapping markup</li>
        <li>Enables format conversion and text analysis</li>
      </ul>
    </div>
  </article>
</div>

<!-- Export Tab -->
<div class="tab-content {{if eq .Tab "export"}}active{{end}}" id="tab-export">
  <article>
    <header>
      <h2>Export Capsules</h2>
      <p class="meta">Convert capsules with IR to different output formats</p>
    </header>

    {{if .CapsulesWithIR}}
    <form method="post" action="/convert" id="export-form">
      <input type="hidden" name="csrf_token" value="{{.CSRFToken}}">
      <input type="hidden" name="action" value="convert">

      <div style="margin-bottom: 1rem; display: flex; gap: 1rem; flex-wrap: wrap; align-items: center;">
        <div>
          <label for="export-format" style="margin-right: 0.5rem;"><strong>Format:</strong></label>
          <select id="export-format" name="format" style="display: inline-block; width: auto;" required>
            {{range .Formats}}
            <option value="{{.}}">{{.}}</option>
            {{end}}
          </select>
        </div>
        <div style="margin-left: auto; display: flex; gap: 0.5rem; align-items: center;">
          <span id="export-selected-count" class="meta">0 selected</span>
          <button type="button" onclick="selectAllExport()" class="secondary outline" style="padding: 0.25rem 0.5rem;">All</button>
          <button type="button" onclick="selectNoneExport()" class="secondary outline" style="padding: 0.25rem 0.5rem;">None</button>
          <button type="submit" style="padding: 0.25rem 0.75rem;">Export</button>
        </div>
      </div>

      <div class="table-responsive">
        <table id="export-table">
          <caption style="caption-side: top; text-align: left; font-weight: bold; padding-bottom: 0.5rem;">Capsules Ready for Export</caption>
          <thead>
            <tr>
              <th style="width: 40px;"><input type="checkbox" id="select-all-export" aria-label="Select all capsules" onchange="toggleSelectAllExport(this)"></th>
              <th>Name</th>
              <th>Format</th>
              <th>Size</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            {{range .CapsulesWithIR}}
            <tr>
              <td><input type="checkbox" name="source" value="{{.Path}}" onchange="updateExportCount()"></td>
              <td><a href="/capsule/{{.Path}}">{{.Name}}</a></td>
              <td><span class="tag">{{.Format}}</span></td>
              <td class="meta">{{.SizeHuman}}</td>
              <td>
                <a href="/ir/{{.Path}}" role="button" class="secondary outline" style="padding: 0.25rem 0.5rem; font-size: 0.875rem;">View IR</a>
              </td>
            </tr>
            {{end}}
          </tbody>
        </table>
      </div>
      <p class="meta">{{len .CapsulesWithIR}} capsule(s) with IR ready for export</p>
    </form>
    {{else}}
    {{if .Capsules}}
    {{template "emptyState" "No capsules with IR found. Use the Generate IR tab to create IR first."}}
    {{else}}
    {{template "emptyState" "No capsules found. Add .tar.xz capsules to the capsules directory."}}
    {{end}}
    {{end}}

    <div style="margin-top: 1.5rem; padding: 1rem; background: var(--pico-card-background-color); border-radius: var(--pico-border-radius);">
      <h4>Supported Export Formats</h4>
      <div class="table-responsive">
        <table>
          <caption style="caption-side: top; text-align: left; font-weight: bold; padding-bottom: 0.5rem;">Supported Export Formats and Loss Classifications</caption>
          <thead>
            <tr>
              <th>Format</th>
              <th>Loss Class</th>
              <th>Description</th>
            </tr>
          </thead>
          <tbody>
            <tr><td>osis</td><td><span class="tag">L0</span></td><td>OSIS XML (lossless)</td></tr>
            <tr><td>usfm</td><td><span class="tag">L0</span></td><td>USFM (lossless)</td></tr>
            <tr><td>usx</td><td><span class="tag">L0</span></td><td>USX XML (lossless)</td></tr>
            <tr><td>json</td><td><span class="tag">L0</span></td><td>JSON structure</td></tr>
            <tr><td>html</td><td><span class="tag">L1</span></td><td>Static HTML site</td></tr>
            <tr><td>epub</td><td><span class="tag">L1</span></td><td>EPUB3 ebook</td></tr>
            <tr><td>markdown</td><td><span class="tag">L1</span></td><td>Hugo-compatible Markdown</td></tr>
            <tr><td>sqlite</td><td><span class="tag">L1</span></td><td>SQLite database</td></tr>
            <tr><td>txt</td><td><span class="tag">L3</span></td><td>Plain text</td></tr>
          </tbody>
        </table>
      </div>
    </div>
  </article>
</div>

<div class="btn-group">
  <a href="/" role="button" class="secondary outline">Back to Home</a>
  <a href="/ingest" role="button" class="secondary outline">Ingest New File</a>
</div>

<script src="/static/capsules.js"></script>

{{template "footer" .}}
