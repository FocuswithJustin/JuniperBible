{{define "sword_module_table"}}
{{/*
  Shared module table template. Expected data fields:
  - .Modules: list of modules with Name/ID, Description, Type/Category, Language, Version
  - .TableID: (optional) HTML id for the table, default "modules-table"
  - .ShowFilters: (optional) whether to show filter controls
  - .ShowActions: (optional) whether to show actions column
  - .ActionType: (optional) "install", "delete", "ingest", or "delete-ingest" - determines action button(s)
  - .ShowDeleteAction: (optional) if true, shows delete button alongside other actions
  - .ShowIngestAction: (optional) if true, shows ingest button alongside other actions
  - .ActionSource: (optional) source name for install actions
  - .CSRFToken: required if ShowActions is true
  - .Types: (optional) list of types for filter dropdown
  - .Languages: (optional) list of languages for filter dropdown
  - .EmptyMessage: (optional) message when no modules
  - .EmptyHint: (optional) secondary message when no modules
  - .FormID: (optional) form id for ingest bulk actions
*/}}

{{if .ShowFilters}}
<!-- Filter Controls -->
<div style="margin-bottom: 1rem; display: flex; gap: 1rem; flex-wrap: wrap; align-items: center;">
  <div>
    <label for="filter-type" style="margin-right: 0.5rem;"><strong>Type:</strong></label>
    <select id="filter-type" data-filter-action="apply" style="display: inline-block; width: auto;">
      <option value="">All Types</option>
      {{range .Types}}
      <option value="{{.}}">{{.}}</option>
      {{end}}
    </select>
  </div>
  <div>
    <label for="filter-language" style="margin-right: 0.5rem;"><strong>Language:</strong></label>
    <select id="filter-language" data-filter-action="apply" style="display: inline-block; width: auto;">
      <option value="">All Languages</option>
      {{range .Languages}}
      <option value="{{.}}">{{.}}</option>
      {{end}}
    </select>
  </div>
  <div>
    <label for="filter-search" style="margin-right: 0.5rem;"><strong>Search:</strong></label>
    <input type="text" id="filter-search" data-filter-action="search" placeholder="Filter by name..." style="display: inline-block; width: 200px;">
  </div>
  <div>
    <button type="button" data-action="clear-filters" class="secondary outline" style="padding: 0.25rem 0.75rem;">Clear Filters</button>
  </div>
  <div style="margin-left: auto; display: flex; gap: 0.5rem; align-items: center;">
    <span id="filter-count" class="meta"></span>
    {{if eq .ActionType "ingest"}}
    <button type="button" data-action="select-all" class="secondary outline" style="padding: 0.25rem 0.5rem;">All</button>
    <button type="button" data-action="select-none" class="secondary outline" style="padding: 0.25rem 0.5rem;">None</button>
    <button type="submit" form="{{if .FormID}}{{.FormID}}{{else}}ingest-form{{end}}" style="padding: 0.25rem 0.75rem;">Ingest Selected</button>
    {{end}}
  </div>
</div>

<!-- Quick Filter Tags -->
{{if .Types}}
<div style="margin-bottom: 1rem;">
  <span class="meta" style="margin-right: 0.5rem;">Quick filters:</span>
  {{range .Types}}
  <span class="tag filter-tag" data-filter-type="type" data-filter-value="{{.}}" data-action="toggle-tag" style="cursor: pointer; margin: 0.125rem; {{if eq . "Bible"}}background: #28a745; color: white;{{else if eq . "Commentary"}}background: #17a2b8; color: white;{{else if eq . "Dictionary"}}background: #6c757d; color: white;{{else if eq . "GenBook"}}background: #ffc107; color: black;{{else}}background: #e9ecef;{{end}}">{{.}}</span>
  {{end}}
</div>
{{end}}
{{end}}

{{if .Modules}}
<div class="table-responsive">
  <table id="{{if .TableID}}{{.TableID}}{{else}}modules-table{{end}}" class="sword-module-table">
    <caption style="caption-side: top; text-align: left; font-weight: bold; padding-bottom: 0.5rem;">SWORD Modules</caption>
    <thead>
      <tr>
        {{if eq .ActionType "ingest"}}<th style="width: 40px;"><input type="checkbox" id="select-all" aria-label="Select all modules" data-action="toggle-select-all"></th>{{end}}
        <th style="white-space: nowrap;">{{if .ShowActions}}Name{{else}}Module ID{{end}}</th>
        <th>Description</th>
        <th style="white-space: nowrap;">{{if .ShowActions}}Type{{else}}Category{{end}}</th>
        <th style="white-space: nowrap;">Language</th>
        <th style="white-space: nowrap;">Version</th>
        {{if .ShowActions}}<th style="white-space: nowrap;">Actions</th>{{end}}
      </tr>
    </thead>
    <tbody>
      {{$root := .}}
      {{range .Modules}}
      <tr data-type="{{if .Type}}{{.Type}}{{else}}{{.Category}}{{end}}" data-language="{{.Language}}" data-name="{{if .Name}}{{.Name}}{{else}}{{.ID}}{{end}}" data-description="{{.Description}}">
        {{if eq $root.ActionType "ingest"}}<td><input type="checkbox" name="modules" value="{{if .ID}}{{.ID}}{{else}}{{.Name}}{{end}}" aria-label="Select {{if .Name}}{{.Name}}{{else}}{{.ID}}{{end}}" form="{{if $root.FormID}}{{$root.FormID}}{{else}}ingest-form{{end}}"></td>{{end}}
        <td><strong>{{if .Name}}{{.Name}}{{else}}{{.ID}}{{end}}</strong></td>
        <td>{{if .Description}}{{truncate .Description 80}}{{else}}<span class="meta">-</span>{{end}}</td>
        <td>
          {{$typeVal := .Type}}{{if not $typeVal}}{{$typeVal = .Category}}{{end}}{{if not $typeVal}}{{$typeVal = "Biblical Texts"}}{{end}}
          {{if eq $typeVal "Bible"}}<span class="tag"{{if $root.ShowFilters}} data-action="set-filter" data-filter-type="type" data-filter-value="{{$typeVal}}"{{end}} style="background: #28a745; color: white;{{if $root.ShowFilters}} cursor: pointer;{{end}}">Bible</span>
          {{else if eq $typeVal "Commentary"}}<span class="tag"{{if $root.ShowFilters}} data-action="set-filter" data-filter-type="type" data-filter-value="{{$typeVal}}"{{end}} style="background: #17a2b8; color: white;{{if $root.ShowFilters}} cursor: pointer;{{end}}">Commentary</span>
          {{else if eq $typeVal "Dictionary"}}<span class="tag"{{if $root.ShowFilters}} data-action="set-filter" data-filter-type="type" data-filter-value="{{$typeVal}}"{{end}} style="background: #6c757d; color: white;{{if $root.ShowFilters}} cursor: pointer;{{end}}">Dictionary</span>
          {{else if eq $typeVal "GenBook"}}<span class="tag"{{if $root.ShowFilters}} data-action="set-filter" data-filter-type="type" data-filter-value="{{$typeVal}}"{{end}} style="background: #ffc107; color: black;{{if $root.ShowFilters}} cursor: pointer;{{end}}">GenBook</span>
          {{else if eq $typeVal "Biblical Texts"}}<span class="meta">Biblical Texts</span>
          {{else}}<span class="tag"{{if $root.ShowFilters}} data-action="set-filter" data-filter-type="type" data-filter-value="{{$typeVal}}" style="cursor: pointer;"{{end}}>{{$typeVal}}</span>{{end}}
        </td>
        <td>{{if .Language}}{{if $root.ShowFilters}}<span class="tag" data-action="set-filter" data-filter-type="language" data-filter-value="{{.Language}}" style="cursor: pointer; background: #e9ecef;">{{.Language}}</span>{{else}}{{.Language}}{{end}}{{else}}<span class="meta">-</span>{{end}}</td>
        <td>{{if .Version}}{{.Version}}{{else}}<span class="meta">-</span>{{end}}</td>
        {{if $root.ShowActions}}
        <td>
          <div class="btn-group" style="display: flex; gap: 0.25rem;">
          {{if eq $root.ActionType "install"}}
          <form method="post" style="display: inline;">
            <input type="hidden" name="csrf_token" value="{{$root.CSRFToken}}">
            <input type="hidden" name="source" value="{{$root.ActionSource}}">
            <input type="hidden" name="action" value="install">
            <input type="hidden" name="module" value="{{if .Name}}{{.Name}}{{else}}{{.ID}}{{end}}">
            <button type="submit" class="secondary outline" style="padding: 0.25rem 0.5rem; font-size: 0.875rem;">Install</button>
          </form>
          {{else if eq $root.ActionType "ingest"}}
          <button type="button" class="secondary outline" data-action="ingest-single" data-module-id="{{if .ID}}{{.ID}}{{else}}{{.Name}}{{end}}" style="padding: 0.25rem 0.5rem; font-size: 0.875rem;">Ingest</button>
          {{end}}
          {{if or (eq $root.ActionType "delete") $root.ShowDeleteAction}}
          <form method="post" style="display: inline;" data-action="confirm-delete">
            <input type="hidden" name="csrf_token" value="{{$root.CSRFToken}}">
            <input type="hidden" name="action" value="delete">
            <input type="hidden" name="module" value="{{if .Name}}{{.Name}}{{else}}{{.ID}}{{end}}">
            <input type="hidden" class="module-name" value="{{if .Name}}{{.Name}}{{else}}{{.ID}}{{end}}">
            <button type="submit" class="btn-delete" style="padding: 0.25rem 0.5rem; font-size: 0.875rem;">Delete</button>
          </form>
          {{end}}
          {{if $root.ShowIngestAction}}
          <form method="post" style="display: inline;">
            <input type="hidden" name="csrf_token" value="{{$root.CSRFToken}}">
            <input type="hidden" name="action" value="ingest">
            <input type="hidden" name="modules" value="{{if .Name}}{{.Name}}{{else}}{{.ID}}{{end}}">
            <button type="submit" class="secondary outline" style="padding: 0.25rem 0.5rem; font-size: 0.875rem;">Ingest</button>
          </form>
          {{end}}
          </div>
        </td>
        {{end}}
      </tr>
      {{end}}
    </tbody>
  </table>
</div>
<p class="meta">Total: {{len .Modules}} module(s)</p>
{{else}}
<div class="empty-state">
  <p>{{if .EmptyMessage}}{{.EmptyMessage}}{{else}}No modules found.{{end}}</p>
  {{if .EmptyHint}}<p class="meta">{{.EmptyHint}}</p>{{end}}
</div>
{{end}}
{{end}}

{{define "sword_filter_script"}}
<script src="/static/module-table.js"></script>
{{end}}
